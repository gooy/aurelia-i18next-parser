{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import through from 'through2';\nimport gutil from \"gulp-util\";\nimport _ from \"lodash\";\nimport fs from \"graceful-fs\";\nimport jsdom from \"jsdom\";\nimport $ from \"jquery\";\n\nimport {hashFromString,mergeHash,replaceEmpty,transformText} from \"./helpers\";\nimport path from \"path\";\nimport File from \"vinyl\";\nimport {AppExtractor} from \"./app-extractor\";\n\nimport corejs from \"core-js\";\nvar Promise = corejs.Promise;\n\nvar PluginError = gutil.PluginError;\n\nconst PLUGIN_NAME = \"aurelia-i18next-parser\";\n\nexport class Parser{\n\n  verbose = false;\n  defaultNamespace ='translation';\n  functions = ['t'];\n  namespaceSeparator = \":\";\n  translation_attribute = \"data-i18n\";\n  image_src = \"data-src\";\n  keySeparator = \".\";\n  regex = null;\n  appPath = null;\n  routesModuleId = \"routes\";\n  locales = ['en-US'];\n  defaultLocale = \"en\";\n\n  registry = [];\n  values = {};\n  nodes = {};\n\n  constructor(opts){\n    if(opts) Object.assign(this,opts);\n\n    if(this.appPath) this.extractor = new AppExtractor(this.appPath);\n  }\n\n  parse(){\n    return this.stream = through.obj(this.transformFile.bind(this), this.flush.bind(this));\n  }\n\n  /**\n   * Figures out how to parse the data based on file extension.\n   *\n   * @param path          path to the file\n   * @param data          data of the file\n   * @returns {Promise}   resolved when data has been parsed\n   */\n  parseTranslations(path,data){\n    var ext = this.getExtension(path);\n    switch(ext){\n      case 'html':\n        if(this.verbose) gutil.log(\"parse HTML:\",path);\n        return this.parseHTML(data);\n      default:\n        if(this.verbose) gutil.log(\"parse JS:\",path);\n        return this.parseJavaScript(data);\n    }\n  }\n\n  /**\n   * Extract translations from javascript code.\n   *\n   * @param data          javascript code as a string\n   * @returns {Promise}   resolved when data has been parsed\n   */\n  parseJavaScript(data){\n\n    var fnPattern = '(?:' + this.functions.join(')|(?:').replace('.', '\\\\.') + ')';\n    var pattern = '[^a-zA-Z0-9_](?:' + fnPattern + ')(?:\\\\(|\\\\s)\\\\s*(?:(?:\\'((?:(?:\\\\\\\\\\')?[^\\']*)+[^\\\\\\\\])\\')|(?:\"((?:(?:\\\\\\\\\")?[^\"]*)+[^\\\\\\\\])\"))';\n    var functionRegex = new RegExp(this.regex || pattern, 'g');\n    var matches;\n    var keys = [];\n\n    while(( matches = functionRegex.exec(data) )){\n      // the key should be the first truthy match\n      for(var i of matches){\n        if(i > 0 && matches[i]) keys.push(matches[i]);\n      }\n    }\n\n    return Promise.resolve(keys);\n  }\n\n  /**\n   * Extract translations from html markup.\n   *\n   * @param data          html markup as a string\n   * @returns {Promise}   resolved when data has been parsed\n   */\n  parseHTML(data){\n    return new Promise((resolve, reject) =>{\n      jsdom.env({\n        html: data,\n        done: (errors, window)=>{\n          if(errors){\n            //throw new new PluginError(PLUGIN_NAME, 'Streams are not supported!');\n            gutil.log(errors);\n            reject(errors);\n            return;\n          }\n          resolve(this.parseDOM(window,$));\n        }\n      });\n    });\n  }\n\n  /**\n   * Extract translations from html markup.\n   *\n   * @param window          a jsdom window\n   * @param $               jquery\n   * @returns {Array}       extracted keys\n   */\n  parseDOM(window,$){\n    $ = $(window);\n    var keys = [];\n    var selector = `[${this.translation_attribute}]`;\n    var nodes = $(selector);\n\n    nodes.each(i=>{\n      var node = nodes.eq(i);\n      var value,key,m;\n\n      key = node.attr(this.translation_attribute);\n\n      var attr = \"text\";\n      //set default attribute to src if this is an image node\n      if(node[0].nodeName===\"IMG\") attr = \"src\";\n\n      var re = /\\[([a-z]*)]/g;\n      //check if a attribute was specified in the key\n      while ((m = re.exec(key)) !== null) {\n        if (m.index === re.lastIndex) {\n          re.lastIndex++;\n        }\n        if(m){\n          key = key.replace(m[0],'');\n          attr = m[1];\n        }\n      }\n\n      switch(node[0].nodeName){\n        case \"IMG\":\n          value = node.attr(this.image_src);\n          break;\n        default:\n          switch(attr){\n            case 'text':\n              value = node.text().trim();\n              break;\n            case 'prepend':\n              value = node.html().trim();\n              break;\n            case 'append':\n              value = node.html().trim();\n              break;\n            case 'html':\n              value = node.html().trim();\n              break;\n            default: //custom attribute\n              value = node.attr(attr);\n              break;\n          }\n      }\n\n      //skip keys with interpolations\n      if(key.indexOf(\"${\") > -1){\n        return;\n      }\n\n      // remove the backslash from escaped quotes\n      key = key.replace(/\\\\('|\")/g, '$1');\n\n      // remove the optional attribute\n      key = key.replace(/\\[[a-z]*]/g, '');\n\n      if(!key) key = value;\n      keys.push(key);\n      this.values[key] = value;\n      this.nodes[key] = node;\n    });\n\n    return keys;\n  }\n\n  /**\n   * Parse and add keys to the registry.\n   * @param keys\n   */\n  addToRegistry(keys){\n    for(let key of keys){\n      // remove the backslash from escaped quotes\n      key = key.replace(/\\\\('|\")/g, '$1');\n\n      if(key.indexOf(this.namespaceSeparator) === -1){\n        key = this.defaultNamespace + this.keySeparator + key;\n      }else{\n        key = key.replace(this.namespaceSeparator, this.keySeparator);\n      }\n\n      this.registry.push(key);\n    }\n  }\n\n  /**\n   * Generate translation files from the current registry entries.\n   *\n   * @param locale\n   */\n  generateTranslation(locale){\n\n    var mergedTranslations, currentTranslations, oldTranslations, key;\n\n    this.registryHash = {};\n\n    // turn the array of keys\n    // into an associative object\n    // ==========================\n    for(var i = 0, l = this.registry.length; i < l; i++){\n      key = this.registry[i];\n      this.registryHash = hashFromString(key, '', this.keySeparator, this.registryHash);\n    }\n\n    for(var namespace in this.registryHash){\n      if(!this.registryHash.hasOwnProperty(namespace)) continue;\n\n      // get previous version of the files\n      var namespacePath = namespace + '.json';\n      var namespaceOldPath = namespace + '_old.json';\n\n      if(fs.existsSync(namespacePath)){\n        try{\n          currentTranslations = JSON.parse(fs.readFileSync(namespacePath));\n        }catch(error){\n          this.emit('json_error', error.name, error.message);\n          currentTranslations = {};\n        }\n      }else{\n        currentTranslations = {};\n      }\n\n      if(fs.existsSync(namespaceOldPath)){\n        try{\n          oldTranslations = JSON.parse(fs.readFileSync(namespaceOldPath));\n        }\n        catch(error){\n          this.emit('json_error', error.name, error.message);\n          currentTranslations = {};\n        }\n      }\n      else{\n        oldTranslations = {};\n      }\n\n      // merges existing translations with the new ones\n      mergedTranslations = mergeHash(currentTranslations, Object.assign({}, this.registryHash[namespace]));\n\n      // restore old translations if the key is empty\n      mergedTranslations.new = replaceEmpty(oldTranslations, mergedTranslations.new);\n\n      var transform = null;\n      //transform values found in the html to uppercase if this is not the default language\n      if(locale !== this.defaultLocale) transform = \"uppercase\";\n\n      mergedTranslations.new = this.getValuesFromHash(this.valuesHash, mergedTranslations.new,transform,this.nodesHash,this.valuesHash);\n\n      // merges former old translations with the new ones\n      mergedTranslations.old = _.extend(oldTranslations, mergedTranslations.new);\n\n      // push files back to the stream\n      var mergedTranslationsFile = new File({\n        path: locale+\"/\"+namespacePath,\n        //base: locale,\n        contents: new Buffer(JSON.stringify(mergedTranslations.new, null, 2))\n      });\n      var mergedOldTranslationsFile = new File({\n        path: locale+\"/\"+namespaceOldPath,\n        //base: locale,\n        contents: new Buffer(JSON.stringify(mergedTranslations.old, null, 2))\n      });\n\n      /*if(this.verbose){\n        gutil.log('writing', locale+\"/\"+namespacePath);\n        gutil.log('writing', locale+\"/\"+namespaceOldPath);\n      }*/\n\n      this.stream.push(mergedTranslationsFile);\n      this.stream.push(mergedOldTranslationsFile);\n    }\n\n  }\n\n  /**\n   * Generate translations for all locales from the registry\n   */\n  generateAllTranslations(){\n    for(var i = 0, l = this.locales.length; i < l; i++){\n      this.generateTranslation(this.locales[i]);\n    }\n  }\n\n  /**\n   * Extract translations from the Aurelia app.\n   *\n   * @returns {Promise}\n   */\n  extractFromApp(){\n   return  this.extractor.getNavFromRoutes(this.routesModuleId)\n    .then(navItems=>{\n        if(!navItems) return null;\n\n        for(var i = 0, l = navItems.length; i < l; i++){\n          var item = navItems[i];\n          this.values[item.i18n] = item.title;\n          this.registry.push(this.defaultNamespace + this.keySeparator + item.i18n);\n        }\n\n        if(this.verbose){\n          gutil.log('navItems found:');\n          gutil.log(navItems)\n        }\n\n        return null;\n      });\n  }\n\n  /**\n   * Takes a `target` hash and replace its empty\n   * values with the `source` hash ones if they exist\n   *\n   * @param source\n   * @param target\n   * @param transform\n   * @param nodesHash\n   * @param valuesHash\n   * @returns {*|{}}\n   */\n  getValuesFromHash(source, target,transform,nodesHash,valuesHash){\n    target = target || {};\n\n    Object.keys(source).forEach((key)=>{\n\n      var node = null;\n      if(nodesHash) node = nodesHash[key];\n      var value;\n\n      if(target[key] !== undefined){\n        if(typeof source[key] === 'object'){\n          target[key] = this.getValuesFromHash(source[key], target[key], transform, node,(valuesHash)? valuesHash[key] : valuesHash);\n        }else if(target[key] === ''){\n          if(!node) {\n            //try to find in values\n            if(valuesHash)value = valuesHash[key];\n            if(transform === \"uppercase\") value = transformText(value);\n          }else{\n            value = source[key];\n            if(transform === \"uppercase\" && node[0].nodeName !== \"IMG\") value = transformText(value);\n          }\n          target[key] = value;\n        }\n      }\n    });\n\n    return target;\n  }\n\n  /**\n   * Get the file extension from a filepath.\n   *\n   * @param path        path to analyze\n   * @returns {string}  the extracted file extension\n   */\n  getExtension(path){\n    return path.substr(path.lastIndexOf(\".\") + 1);\n  }\n\n\n\n  //--------- Steam functions\n\n  transformFile(file, encoding, cb) {\n\n    var data,path;\n\n    // we do not handle streams\n    if (file.isStream()) {\n      this.emit('error', new PluginError(PLUGIN_NAME, 'Streams are not supported!'));\n      return cb();\n    }\n\n    //read the file manually if a filepath was passed.\n    if(file.isNull()){\n      path = file.path;\n      if(file.stat.isDirectory()){\n        return cb();\n      }else if(path && fs.existsSync(path)){\n        data = fs.readFileSync(path);\n      }else{\n        this.emit(\"error\", new PluginError(PLUGIN_NAME, \"File has no content and is not readable\"));\n        return cb();\n      }\n    }\n\n    if (file.isBuffer()) {\n      path = file.path.replace(process.cwd()+\"/\",\"\");\n      data = file.contents.toString();\n    }\n\n    //skip if no data was found\n    if(!data) return cb();\n\n    data = this.parseTranslations(path,data).then(keys=>{\n      this.addToRegistry(keys);\n      // tell the stream engine that we are done with this file\n      cb();\n    });\n\n    // make sure the file goes through the next gulp plugin\n    //this.push(file);\n  }\n\n  flush(cb){\n    if(this.verbose) {\n      gutil.log('extracted registry:');\n      gutil.log(this.registry);\n    }\n\n    this.translationsHash = {};\n    this.valuesHash = {};\n    this.nodesHash = {};\n\n    var key,i,l;\n\n    // remove duplicate keys\n    this.translations = _.uniq(this.translations).sort();\n\n    //create hash for values\n    for(key in this.values){\n      if(!this.values.hasOwnProperty(key)) continue;\n      this.valuesHash = hashFromString(key, this.values[key], this.keySeparator, this.valuesHash);\n    }\n    //create hash for nodes\n    for(key in this.nodes){\n      if(!this.nodes.hasOwnProperty(key)) continue;\n      this.nodesHash = hashFromString(key, this.nodes[key], this.keySeparator, this.nodesHash);\n    }\n\n    //extract values from the aurelia application where possible\n    if(this.extractor){\n      this.extractFromApp().then(()=>{\n        this.generateAllTranslations();\n        cb();\n      });\n    }else{\n      this.generateAllTranslations();\n      cb();\n    }\n\n  }\n}\n\n/**\n * The main plugin function\n *\n * @param opts\n * @returns {Stream}\n */\nexport function i18next(opts) {\n  return new Parser(opts).parse();\n}\n"],"sourceRoot":"/source/"}